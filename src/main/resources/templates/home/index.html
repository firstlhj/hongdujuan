<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <link rel="stylesheet" href="/wxpay/css/index.css">
    <title>杜鹃花</title>
    <div th:replace="shared/layout_header"></div>
    <style>

    </style>
</head>

<body>
<header>
    <img src="https://hongdujuan.oss-cn-shenzhen.aliyuncs.com/img1.gif" alt="">
</header>
<div class="details">
    <div class="personal-title">
        <img src="https://hongdujuan.oss-cn-shenzhen.aliyuncs.com/timg.gif" alt="">
    </div>
    <div style="width: 74%; margin: 0 auto;">
        <img src="https://hongdujuan.oss-cn-shenzhen.aliyuncs.com/zhutu.png" alt="">
    </div>
    <div class="levitate">
        <div class="levitate-types" id='personal'>
            <p>个人认种</p>
        </div>
        <div class="levitate-types" id="enterprise">
            <p>企业认种</p>
        </div>
        <div class="levitate-types" id='reptive'>
            <p>代人认种</p>
        </div>
        <div class="levitate-types" id='family'>
            <p>家庭认种</p>
        </div>
    </div>
    <div class="footer">
        <p>小黑物联科技提供技术支持</p>
        <div/>
    </div>


    <div th:switch="${showMyTree}">
        <div th:case="true">
            <div class="name_cmd">
                <a href="/wxpay/product" style="color: #ffdda4;">
                    <p style="height:.6rem">我</p>
                    <p style="height:.6rem">的</p>
                    <p style="height:.6rem">认</p>
                    <p style="height:.6rem">种</p>
                </a>
            </div>
        </div>
    </div>


    <div class="popup">
        <form id="mainForm">
            <div class="popup-title">
                <p id="description">个人认种</p>
            </div>
            <div class="popup-box">
                <div class="popup-num">
                    <p>数量</p>
                </div>
                <div class="input-group">
                    <div class="select">
                        <a id="num-jian" href="javascript:" class="btn btn_minus" role="button" title="减少"></a>
                        <input class="inputNum" type="number" value="1" size="1" id='quantity'>
                        <a id="num-jia" href="javascript:" class="btn btn_plus" role="button" title="增加"></a>
                    </div>
                </div>
            </div>
            <div class="popup-box">
                <div class="popup-num">
                    <p id="namein">姓名</p>
                </div>
                <div class="input-group">
                    <div class="select" style="text-align: center;">
                        <input class="inputNum" value="" size="1" id="placename" placeholder="请输入姓名">
                    </div>
                </div>
            </div>
            <div class="popup-box" id="input-phone">
                <div class="popup-num">
                    <p>电话</p>
                </div>
                <div class="input-group">
                    <div class="select" style="text-align: center;">
                        <input class="inputNum" value="" size="1" id="phone" placeholder="请输入电话" type="text">
                    </div>
                </div>
            </div>

            <div class="confirm-box">
                <div class="whether" id="determine">
                    <p style="color: #333;font-size: .46rem;padding: .2rem 0; font-weight: 700;" id="confirmOrder">
                        确认</p>
                </div>
            </div>
            <div class="down">
                <img src="/wxpay/img/gbi.png" alt="">
            </div>
        </form>
    </div>

    <div id='guide'></div>


</body>

</html>

<template th:replace="shared/layout_scripts"></template>
<script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script>
<script>
    //节流阀
    const throttle = (fun, delay) => {
        let last, deferTimer
        return function (args) {
            let _args = arguments
            let now = +new Date()
            if (last && now < last + delay) {
                clearTimeout(deferTimer)
                deferTimer = setTimeout(function () {
                    last = now
                    fun.apply(this, _args)
                }, delay)
            } else {
                last = now
                fun.apply(this, _args)
            }
        }
    }
    //iphoneX 底部偏差
    const isIphonex = () => {
        if (typeof window !== 'undefined' && window) {
            return /iphone/gi.test(window.navigator.userAgent) && window.screen.height >= 812;
        }
        return false;
    };

    const onTop = e => {
        let div = document.querySelector('.levitate');
        const osTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop;
        if (isIphonex()) {
            osTop > 620 ? div.classList.remove('box-6') : div.classList.add('box-6');
        } else {
            osTop > 720 ? div.classList.remove('box-6') : div.classList.add('box-6');
        }

    }
    let throttleScroll = throttle(onTop, 500)
    window.addEventListener("scroll", throttleScroll);

    let $quantity = $('#quantity');
    let $description = $('#description')
    $('#num-jia').on('click', function () {
        let quantity = parseInt($quantity.val()) + 1;
        if (quantity > 100) {
            layer.msg("种植数量不能超过100", {icon: 0});
            return;
        }

        $quantity.val(quantity)
    })
    $('#num-jian').on('click', function () {
        let quantity = parseInt($quantity.val()) - 1;
        if (quantity <= 0) {
            return;
        }

        $quantity.val(quantity)
    })

    function libmagic() {
        $('.popup').fadeIn(500);
        $('#guide').fadeIn(500);
        $('#namein').text('姓名');
        $('#placename').attr('placeholder', '请输入姓名');
        $('#input-phone').css({'opacity': '1'})
        // stopBodyScroll(guide)
    }

    $('#personal').on('click', function () {
        $description.text('个人认种')
        libmagic();
        orderType = 0;
    })
    $('#enterprise').on('click', function () {
        $description.text('企业认种')
        $('.popup').fadeIn(500);
        $('#guide').fadeIn(500);
        $('#namein').text('公司');
        $('#placename').attr('placeholder', '请输入公司名');
        $('#input-phone').css({'opacity': '0'})
        // stopBodyScroll(guide);

        orderType = 1;
    })
    $('#reptive').on('click', function () {
        $description.text('代人认种')
        libmagic();

        orderType = 2;
    })
    $('#family').on('click', function () {
        $description.text('家庭认种')
        libmagic();

        orderType = 3;
    })
    $('.down').on('click', function () {
        $('.popup').fadeOut(500);
        $('#guide').fadeOut(500);
        // $quantity.val(1);
        // stopBodyScroll();

        document.getElementById("mainForm").reset();
    });

    function checkPhone(phone) {
        return (/^1[3456789]\d{9}$/.test(phone);
    }

    var orderType;

    $(function () {

        // 获取当前链接地址，不带参数部分
        const currentUrl = location.origin + location.pathname;

        // 微信js初始化完成回调
        wx.ready(function () {
            wx.updateTimelineShareData({
                title: '种植红杜鹃', // 分享标题
                link: currentUrl, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                // imgUrl: '/img/shu.png', // 分享图标
                success: function () {
                    // 设置成功
                }
            });

            wx.updateAppMessageShareData({
                title: '种植红杜鹃', // 分享标题
                desc: '为主席家乡种植红杜鹃', // 分享描述
                link: currentUrl, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                // imgUrl: '/img/shu.png', // 分享图标
                success: function () {
                    // 设置成功
                }
            });
        });

        wx.error(function (res) {
            layer.msg("微信分享接口初始化失败");
        });

        const params = {};
        // 授权验证js api
        $.ajax({
            type: "post",
            dataType: 'json',
            url: "/wxpay/jspai/getConfig",
            contentType: "application/json;charset=utf-8",
            data: JSON.stringify(params),
            error: function (res) {
                closeLoad();
            },
            success: function (res) {
                closeLoad();

                if (res.code) {
                    wx.config(Object.assign({
                        debug: false,
                        jsApiList: ['updateAppMessageShareData', 'updateTimelineShareData'],
                    }, res.data));
                } else {
                    layer.alert(res.msg, {icon: 2});
                }
            }
        });

        // 数量验证
        $("#quantity").change(function () {
            let quantity = parseInt(this.value);

            if (quantity > 100) {
                layer.msg("种植数量不能超过100", {icon: 0});
                // this.value = 100;
            } else if (quantity < 1) {
                layer.msg("种植数量不能小于1", {icon: 0});
                this.value = 1;
            }
        });

        // 数量验证
        $("#phone").change(function () {
            let phone = this.value;

            if (phone && !checkPhone(phone)) {
                layer.msg("请填写正确格式的手机号码", {icon: 0});
            }
        });

        // 下单按钮
        $("#confirmOrder").click(function () {
            let quantity = $("#quantity").change().val();
            let name = $("#placename").val();
            let phone = $("#phone").change().val();

            if (quantity > 100 || quantity < 1) {
                // layer.msg("种植数量不正确", {icon: 2});
                return;
            }
            if (!name) {
                layer.msg("请填写姓名/名称", {icon: 2});
                return;
            }
            if (orderType !== 1 && !phone) {
                layer.msg("请填写电话号码", {icon: 2});
                return;
            }

            showLoad();

            var orderData = {
                productCode: "001",
                type: orderType,
                quantity: quantity,
                name: name,
                phone: phone,
            };

            $.ajax({
                type: "post",
                dataType: 'json',
                url: "/wxpay/order/create",
                contentType: "application/json;charset=utf-8",
                data: JSON.stringify(orderData),
                success: function (res) {
                    if (res.code) {
                        // 下单成功跳转支付
                        location.href = `/wxpay/pay/${res.data}`;
                    } else {
                        layer.alert(res.msg, {icon: 2});
                    }
                },
                error: function (res) {
                    layer.alert(JSON.stringify(res), {icon: 2});
                    console.log(res);
                },
                done: function (res) {
                    closeLoad();
                }
            });
        });
    })
</script>